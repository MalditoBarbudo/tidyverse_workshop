<!DOCTYPE html>
<html>
  <head>
    <title>An introduction to the tidyverse</title>
    <meta charset="utf-8">
    <meta name="author" content="Aitor Ameztegui &amp; Víctor Granda" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/font-awesome/css/fontawesome-all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="custom.css" type="text/css" />
    <link rel="stylesheet" href="custom-fonts.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">




class: title-slide

# An introduction to the tidyverse

## tidyr, dplyr and purrr

### Aitor Ameztegui (@multivac42)
### Víctor Granda (@malditobarbudo)


#### **I SIbEcol meeting** (Barcelona, 4 de Febrero de 2019)


---
layout: true

&lt;div class="tweaked-header" style="background-image: url(resources/images/tidyverse.png)"&gt;&lt;/div&gt;

---

# tidyr, dplyr &amp; purr: the tidyverse

--
background-image: url(resources/images/hadley.png)
background-position: right bottom

Created by Hadley Wickham, chief scientist of RStudio, and author of more than
30 R packages (`readr`, `ggplot2`, `plyr`, `devtools`, `roxygen2`, `rmarkdown`...)

--

The **tidyverse** is made up of those packages (and others), as a suite designed
to ease the data analysis in all its steps.

--

![](resources/images/tidyverse_schema.png)

---

# Before we start...

- Neither `tidyr`, nor `dplyr` or `purrr` do anything that can't be done with
  base R code, apply family functions, for-loops or other packages.  

- Designed to be more eficient (in time), easier to read and easier to use
  (it may requires some adaptation if used to base R code).  

- Valid mostly for data.frames. For other formats (matrices, arrays) `plyr` can
  be used.

---

# *tidyverse*: tidy data

.center[
![](resources/images/tidy_data.png)
]

--

  - Data in **tidy** format eases the processing and analysis, particularly in
    vectorized lenguages as R can be.
    
---

# our data

  1. `plots [11858 x 15]`: all plots from the Third Spanish Forest Inventory
     (IFN3) in Catalonia
  
  2. `trees [111756 x 12]`: all trees with dbh &gt; 7.5 cm measured in both
     IFN2 and IFN3
  
  3. `species [14778 x 15]`: number of trees per hectare in each plot, by
     species and size class
  
  4. `coordinates [11858 x 6]`: X and Y UTM coordinates of each plot.
  
  5. `leaf [10447 x 3]`: leaf biomass and carbon content for those IFN 3 plots where they
    where available

---

# let's have a look at the data




```r
trees
```

```
## # A tibble: 111,756 x 12
##    Codi  Provincia Cla   Subclase Especie Rumbo  Dist    Fac    CD
##    &lt;fct&gt; &lt;chr&gt;     &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1 0800… 08        A     1        022         7  8.3   31.8     20
##  2 0800… 08        A     1        476        38  9.1   31.8     35
##  3 0800… 08        A     1        021        25  7     31.8     25
##  4 0800… 08        A     1        021        28  8.89  31.8     15
##  5 0800… 08        A     1        021        19 11.2   14.1     35
##  6 0800… 08        A     1        021        32 12     14.1     35
##  7 0800… 08        A     1        243        40  7.8   31.8     15
##  8 0800… 08        A     1        045        16  5.09  31.8     20
##  9 0800… 08        A     1        243        47 26.9    5.09    65
## 10 0800… 08        A     1        022        44  2.7  127.      15
## # … with 111,746 more rows, and 3 more variables: DiamIf3 &lt;dbl&gt;,
## #   DiamIf2 &lt;dbl&gt;, HeiIf3 &lt;dbl&gt;
```

---

# let's have a look at the data

Tibbles, not usual data.frames:

  - class `tbl_df`
  
  - print only 10 rows by default
  
  - inform about variable types

---
layout: false
class: inverse
background-image: url(resources/images/dplyr.png)

# dplyr

---
layout: true

&lt;div class="tweaked-header" style="background-image: url(resources/images/dplyr.png)"&gt;&lt;/div&gt;
---

# 5 main verbs of dplyr

  - `filter`: keep the rows that match a condition
  
  - `select`: keep columns by name
  
  - `arrange`: sort rows
  
  - `mutate`: transform existent variables or create new ones
  
  - `summarise`: do some summary statistics and reduce data

---

# common structure (for most of the tidyverse)

```r
verb(data, ...)
```

- first argument: data (as data.frame or tbl_df)
- the rest of arguments specify what to do with the data frame
- output is always another tbl_df
- unless we are assigning (`&lt;-`), never modifies the original data frame

---

# Selecting rows (`filter`)


```r
filter(trees, Dist &lt; 3)
```

```
## # A tibble: 11,601 x 12
##    Codi  Provincia Cla   Subclase Especie Rumbo  Dist   Fac    CD
##    &lt;fct&gt; &lt;chr&gt;     &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 0800… 08        A     1        022        44  2.7   127.    15
##  2 0800… 08        A     1        021         9  1     127.    30
##  3 0800… 08        A     1        021         2  0.6   127.    25
##  4 0800… 08        A     1        021        17  2.59  127.    15
##  5 0800… 08        A     1        022         5  2.29  127.    20
##  6 0800… 08        A     1        022        10  2.09  127.    15
##  7 0801… 08        A     1        476         3  2.29  127.    10
##  8 0801… 08        A     1        243        24  2.7   127.    10
##  9 0801… 08        A     1        243       103  2.79  127.    10
## 10 0801… 08        A     1        021         2  2     127.    25
## # … with 11,591 more rows, and 3 more variables: DiamIf3 &lt;dbl&gt;,
## #   DiamIf2 &lt;dbl&gt;, HeiIf3 &lt;dbl&gt;
```


---

# Selecting rows (`filter`)


```r
filter(trees, Provincia == '25')
```

```
## # A tibble: 35,665 x 12
##    Codi  Provincia Cla   Subclase Especie Rumbo  Dist    Fac    CD
##    &lt;fct&gt; &lt;chr&gt;     &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1 2500… 25        A     1        071        59 29.3    5.09    70
##  2 2500… 25        A     1        071        18 25.5    5.09    50
##  3 2500… 25        A     1        042        19 22.4    5.09    70
##  4 2500… 25        A     1        255        26  7.3   31.8     30
##  5 2500… 25        A     1        071        40  8.89  31.8     15
##  6 2500… 25        A     1        042       203  3.79 127.      15
##  7 2500… 25        A     1        071        34  7.4   31.8     50
##  8 2500… 25        A     1        031        51 21.5    5.09    55
##  9 2500… 25        A     1        071         4 13.5   14.1     50
## 10 2500… 25        A     1        073        40 10.3   14.1     20
## # … with 35,655 more rows, and 3 more variables: DiamIf3 &lt;dbl&gt;,
## #   DiamIf2 &lt;dbl&gt;, HeiIf3 &lt;dbl&gt;
```

---

# Selecting rows (`filter`)


```r
filter(trees, CD %in% c(45, 70))
```

```
## # A tibble: 2,552 x 12
##    Codi  Provincia Cla   Subclase Especie Rumbo  Dist   Fac    CD
##    &lt;fct&gt; &lt;chr&gt;     &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 0800… 08        A     1        071         9 26.9   5.09    45
##  2 0801… 08        A     1        021        19 11.1  14.1     70
##  3 0806… 08        A     1        042        43  7.09 31.8     45
##  4 0807… 08        A     1        042        16 15.8   5.09    45
##  5 0807… 08        A     1        042         3  9.69 31.8     45
##  6 0812… 08        A     1        024        93 10.8  14.1     45
##  7 0812… 08        A     1        024        87 10.1  14.1     45
##  8 0813… 08        A     1        026        16  8.6  31.8     45
##  9 0814… 08        A     1        054        51  5.19 31.8     70
## 10 0819… 08        A     1        024         1 10.3  14.1     45
## # … with 2,542 more rows, and 3 more variables: DiamIf3 &lt;dbl&gt;,
## #   DiamIf2 &lt;dbl&gt;, HeiIf3 &lt;dbl&gt;
```

---

# Selecting rows (`filter`)

![](resources/images/logical_operators.png)

---

# Selecting rows (`filter`)

## Exercise 1

Let's find those plots in IFN3n (`plots` data frame) that:

  1.1 Are located either in Barcelona (08) or Girona (17)
  
  1.2 Were measured **before** January 2001
  
  1.3 It took **more** than 2 hours to measure (7200s)


---

# Selecting columns (`select`)


```r
trees
```

```
## # A tibble: 111,756 x 12
##    Codi  Provincia Cla   Subclase Especie Rumbo  Dist    Fac    CD
##    &lt;fct&gt; &lt;chr&gt;     &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1 0800… 08        A     1        022         7  8.3   31.8     20
##  2 0800… 08        A     1        476        38  9.1   31.8     35
##  3 0800… 08        A     1        021        25  7     31.8     25
##  4 0800… 08        A     1        021        28  8.89  31.8     15
##  5 0800… 08        A     1        021        19 11.2   14.1     35
##  6 0800… 08        A     1        021        32 12     14.1     35
##  7 0800… 08        A     1        243        40  7.8   31.8     15
##  8 0800… 08        A     1        045        16  5.09  31.8     20
##  9 0800… 08        A     1        243        47 26.9    5.09    65
## 10 0800… 08        A     1        022        44  2.7  127.      15
## # … with 111,746 more rows, and 3 more variables: DiamIf3 &lt;dbl&gt;,
## #   DiamIf2 &lt;dbl&gt;, HeiIf3 &lt;dbl&gt;
```

---

# Selecting columns (`select`)


```r
select(trees, DiamIf3)
```

```
## # A tibble: 111,756 x 1
##    DiamIf3
##      &lt;dbl&gt;
##  1    20.3
##  2    34  
##  3    24.8
##  4    16.8
##  5    34.0
##  6    33.1
##  7    15  
##  8    17.5
##  9    67.4
## 10    15.1
## # … with 111,746 more rows
```

---

# Selecting columns (`select`)


```r
select(trees, -Codi)
```

```
## # A tibble: 111,756 x 11
##    Provincia Cla   Subclase Especie Rumbo  Dist    Fac    CD DiamIf3
##    &lt;chr&gt;     &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
##  1 08        A     1        022         7  8.3   31.8     20    20.3
##  2 08        A     1        476        38  9.1   31.8     35    34  
##  3 08        A     1        021        25  7     31.8     25    24.8
##  4 08        A     1        021        28  8.89  31.8     15    16.8
##  5 08        A     1        021        19 11.2   14.1     35    34.0
##  6 08        A     1        021        32 12     14.1     35    33.1
##  7 08        A     1        243        40  7.8   31.8     15    15  
##  8 08        A     1        045        16  5.09  31.8     20    17.5
##  9 08        A     1        243        47 26.9    5.09    65    67.4
## 10 08        A     1        022        44  2.7  127.      15    15.1
## # … with 111,746 more rows, and 2 more variables: DiamIf2 &lt;dbl&gt;,
## #   HeiIf3 &lt;dbl&gt;
```

---

# Selecting columns (`select`)


```r
select(trees, Codi:Cla)
```

```
## # A tibble: 111,756 x 3
##    Codi   Provincia Cla  
##    &lt;fct&gt;  &lt;chr&gt;     &lt;fct&gt;
##  1 080001 08        A    
##  2 080002 08        A    
##  3 080003 08        A    
##  4 080004 08        A    
##  5 080006 08        A    
##  6 080007 08        A    
##  7 080008 08        A    
##  8 080009 08        A    
##  9 080010 08        A    
## 10 080013 08        A    
## # … with 111,746 more rows
```

---

# Selecting columns (`select`)

## Special functions:

- `starts_with`
- `ends_with`
- `contains`
- `match`
- `num_range`
- `one_of`
- `everything`

---

# Selecting columns (`select`)


```r
select(trees, starts_with('Diam'))
```

```
## # A tibble: 111,756 x 2
##    DiamIf3 DiamIf2
##      &lt;dbl&gt;   &lt;dbl&gt;
##  1    20.3    18.9
##  2    34      32.4
##  3    24.8    17.6
##  4    16.8    12.6
##  5    34.0    30.9
##  6    33.1    28.2
##  7    15      13.2
##  8    17.5    15.3
##  9    67.4    66.8
## 10    15.1    12.6
## # … with 111,746 more rows
```

---

# Selecting columns (`select`)

## Exercise 2

Think if three or four ways to select the variables that define the start and finish date
of plot measuring

---

# Sorting rows (`arrange`)


```r
arrange(trees, Dist)
```

```
## # A tibble: 111,756 x 12
##    Codi  Provincia Cla   Subclase Especie Rumbo  Dist   Fac    CD
##    &lt;fct&gt; &lt;chr&gt;     &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 1706… 17        A     1        021        73   0    127.    15
##  2 2518… 25        A     1        025       174   0.3  127.    15
##  3 1706… 17        A     1        045       290   0.3  127.    10
##  4 0815… 08        A     1        025       176   0.3  127.    20
##  5 0810… 08        A     1        025       107   0.4  127.    15
##  6 4301… 43        A     1        024         0   0.4  127.    25
##  7 4306… 43        A     1        021        17   0.4  127.    15
##  8 1719… 17        A     1        079       150   0.4  127.    20
##  9 1719… 17        A     1        045        34   0.4  127.    25
## 10 1720… 17        A     1        045       160   0.4  127.    15
## # … with 111,746 more rows, and 3 more variables: DiamIf3 &lt;dbl&gt;,
## #   DiamIf2 &lt;dbl&gt;, HeiIf3 &lt;dbl&gt;
```


---

# Sorting rows (`arrange`)


```r
arrange(trees, desc(Dist))
```

```
## # A tibble: 111,756 x 12
##    Codi  Provincia Cla   Subclase Especie Rumbo  Dist   Fac    CD
##    &lt;fct&gt; &lt;chr&gt;     &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 2500… 25        A     1        042       398  36.5  5.09    70
##  2 2500… 25        A     1        031       350  34.8  5.09    70
##  3 2501… 25        A     1        022       158  33.9  5.09    50
##  4 2500… 25        A     1        021       110  33.6  5.09    60
##  5 2500… 25        A     1        031       238  33.5  5.09    50
##  6 2500… 25        A     1        071       214  32.9  5.09    70
##  7 2517… 25        A     1        045       163  32.8  5.09    60
##  8 2500… 25        A     1        031       119  32.5  5.09    65
##  9 2500… 25        A     1        031       390  32.1  5.09    45
## 10 1712… 17        A     1        071        38  31.4  5.09    60
## # … with 111,746 more rows, and 3 more variables: DiamIf3 &lt;dbl&gt;,
## #   DiamIf2 &lt;dbl&gt;, HeiIf3 &lt;dbl&gt;
```

---

# Sorting rows (`arrange`)

## Exercise 3

  3.1 Sort plots by date and hour of measurement
  
  3.2 Which plots were started to be measured later in the day?
  
  3.3 Which plots took longer to be measured?

---

# Transforming variables (`mutate`)


```r
mutate(
  trees,
  Dist = Dist * 100
)
```

```
## # A tibble: 111,756 x 12
##    Codi  Provincia Cla   Subclase Especie Rumbo  Dist    Fac    CD
##    &lt;fct&gt; &lt;chr&gt;     &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1 0800… 08        A     1        022         7  830.  31.8     20
##  2 0800… 08        A     1        476        38  910   31.8     35
##  3 0800… 08        A     1        021        25  700   31.8     25
##  4 0800… 08        A     1        021        28  889   31.8     15
##  5 0800… 08        A     1        021        19 1119   14.1     35
##  6 0800… 08        A     1        021        32 1200   14.1     35
##  7 0800… 08        A     1        243        40  780   31.8     15
##  8 0800… 08        A     1        045        16  509   31.8     20
##  9 0800… 08        A     1        243        47 2689    5.09    65
## 10 0800… 08        A     1        022        44  270  127.      15
## # … with 111,746 more rows, and 3 more variables: DiamIf3 &lt;dbl&gt;,
## #   DiamIf2 &lt;dbl&gt;, HeiIf3 &lt;dbl&gt;
```


---

# Transforming variables (`mutate`)


```r
mutate(
  trees,
  Alometria = DiamIf3 / HeiIf3,
  Alometria2 = Alometria * DiamIf2
)
```

```
## # A tibble: 111,756 x 14
##    Codi  Provincia Cla   Subclase Especie Rumbo  Dist    Fac    CD
##    &lt;fct&gt; &lt;chr&gt;     &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1 0800… 08        A     1        022         7  8.3   31.8     20
##  2 0800… 08        A     1        476        38  9.1   31.8     35
##  3 0800… 08        A     1        021        25  7     31.8     25
##  4 0800… 08        A     1        021        28  8.89  31.8     15
##  5 0800… 08        A     1        021        19 11.2   14.1     35
##  6 0800… 08        A     1        021        32 12     14.1     35
##  7 0800… 08        A     1        243        40  7.8   31.8     15
##  8 0800… 08        A     1        045        16  5.09  31.8     20
##  9 0800… 08        A     1        243        47 26.9    5.09    65
## 10 0800… 08        A     1        022        44  2.7  127.      15
## # … with 111,746 more rows, and 5 more variables: DiamIf3 &lt;dbl&gt;,
## #   DiamIf2 &lt;dbl&gt;, HeiIf3 &lt;dbl&gt;, Alometria &lt;dbl&gt;, Alometria2 &lt;dbl&gt;
```

---

# Transforming variables (`mutate`)

## Exercise 4

  4.1 Get growth (in cm) of each tree between IFN2 and IFN3

  4.2 Create two new variables with basal area per hectare of each tree, both for IFN2 and
      Ifn3. Which is the species of the fastest-growing tree in basal area?

$$
AB = \frac{\pi}{4} · Diam^{2} · N
$$
---

# Reducing variables (`summarise`)


```r
summarise(trees, mean_if3 = mean(DiamIf3))
```

```
## # A tibble: 1 x 1
##   mean_if3
##      &lt;dbl&gt;
## 1     23.4
```

---

# Reducing variables (`summarise`)

## Summary functions

  - `min(x)`, `max(x)`, `quantile(x, p)`
  - `mean(x)`, `median(x)`, 
  - `sd(x)`, `var(x)`, `IQR(x)`
  - `n()`, `n_distinct(x)`
  
  - `sum(x &gt; 10)`, `mean(x &gt; 10)`

---

# Reducing variables (`summarise`)

## Grouped summarise


```r
by_province &lt;- group_by(plots, Provincia)
summarise(
  by_province,
  mean_ph_ifn3 = mean(PhSuelo, na.rm = TRUE),
  max_ph_ifn3 = max(PhSuelo, na.rm = TRUE),
  min_ph_ifn3 = min(PhSuelo, na.rm = TRUE)
)
```

```
## # A tibble: 4 x 4
##   Provincia mean_ph_ifn3 max_ph_ifn3 min_ph_ifn3
##   &lt;chr&gt;            &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
## 1 08                4.72           6           3
## 2 17                4.13           6           3
## 3 25                4.38           8           3
## 4 43                4.87           6           4
```

---

# Reducing variables (`summarise`)

## Exercise 5

Which statistics would you calculate to characterize diameter values in each plot?

---
layout: true

&lt;div class="tweaked-header" style="background-image: url(resources/images/pipe.png)"&gt;&lt;/div&gt;

---
class: code80

# Data pipelines (`%&gt;%`)

  - Often, we want to use several verbs (filter, arrange, group_by, summarise...)

  - Multiple operations are difficult to read, or require to create multiple intermediate
    objects:

.pull-left[


```r
diam_especie &lt;- filter(
  summarise(
    group_by(
      filter(
        trees, !is.na(DiamIf3)
      ),
      Codi, Especie
    ),
    diam = mean(DiamIf3),
    n = n()
  ),
  n &gt; 5
)
```

]

.pull-right[


```r
no_na_trees &lt;- filter(
  trees, !is.na(DiamIf3)
)
no_na_trees_grouped &lt;- group_by(
  no_na_trees, Codi, Especie
)
summarised_no_na_trees &lt;- summarise(
  no_na_trees_grouped,
  diam = mean(DiamIf3), n = n()
)
final_data &lt;- filter(
  summarised_no_na_trees, n &gt; 5
)
```

]

---

# Data pipelines (`%&gt;%`)

  - Alternative (cleaner and easy to read): *pipe* operator (`%&gt;%`) from `magrittr` package
  
  - The result of the left side is passed to the function in the right as first argument:
  
  `f(x, y)` is the same as `x %&gt;% f(y)`  
  `f(x, y, z)` is the same as `x %&gt;% f(y, z)`

  - In the tidyverse `%&gt;%` makes each function to be applied to the data frame resulting
    from the previous step
  
  `filter(df, color == 'blue')` is the same as `df %&gt;% filter(color == 'blue')`  
  `mutate(df, double = 2*value)` is the same as `df %&gt;% mutate(double = 2*value)`

---
class: code80

# Data pipelines (`%&gt;%`)

.pull-left[

Nested functions


```r
diam_especie &lt;- filter(
  summarise(
    group_by(
      filter(
        trees, !is.na(DiamIf3)
      ),
      Codi, Especie
    ),
    diam = mean(DiamIf3),
    n = n()
  ),
  n &gt; 5
)
```

]

--

.pull-right[

Functions key


```r
diam_especie &lt;- trees %&gt;%
  filter(!is.na(DiamIf3)) %&gt;%
  group_by(Codi, Especie) %&gt;%
  summarise(
    diam = mean(DiamIf3),
    n = n()
  ) %&gt;%
  filter(n &gt; 5)
```

]

---

# Data pipelines (`%&gt;%`)

## Exercise 6

Create pipelines to answer the following questions:

  6.1 Which plots have the fastest average growth rate?
  
  6.2 Which is the plot with the most species?
  
  6.3 Is there any relationship between both variables?

---
layout: true

&lt;div class="tweaked-header" style="background-image: url(resources/images/dplyr.png)"&gt;&lt;/div&gt;

---

# Grouped `mutate`/`filter`

We will commonly use groups (`group_by`) when summarising variables:

```r
group_by(Especie) %&gt;% summarise(mean = mean(Diam))
```

Sometimes, however, we may be interested in calculating new variables by group, but without
reducing the dimensions:

```r
group_by(Especie) %&gt;% mutate(
  std_diam = Diam - mean(Diam)
)
```

---

# Grouped `mutate`/`filter`

## Exercise 7

  7.1 Identify those trees that grow most as comared to the average in that plot
  
  7.2 Identify those plots where a species grows much more than the average for the species

Extra (in case you get bored):  

  7.3 Select IFN plots with pure *Pinus nigra* stands (Especie =
      025). Note: we consider a forest to be monospecific when &gt; 80% in BA corresponds to
      a single species
      

---

# Joining data (`*_join`)

## Mutating joins

  - `left_join(x, y)`: Add observations in y that also appears in x. Original observations
    (x) are not lost
  
  - `right_join(x, y)`: Add observations in x that also appears in y. Original observations
    (y) are not lost
  
  - `full_join(x, y)`: All observations, x and y
  
  - `inner_join(x, y)`: Only observastions present in x and y

---

# Joining data (`*_join`)

## Filtering joins

  - `semi_join(x, y)`: Keep observations in x that are present in y
  
  - `anti_join(x, y)`: Remove observations in x present in y

---

# Joining data (`*_join`)

## Exercise 8

Add X and Y coordinates that are included in the `coordinates` data frame to each plot in
the `plots` data frame

---
layout: false
class: inverse
background-image: url(resources/images/tidyr.png)

# tidyr

---
layout: true

&lt;div class="tweaked-header" style="background-image: url(resources/images/tidyr.png)"&gt;&lt;/div&gt;

---

# tidy data

.center[
![](resources/images/tidy_data.png)
]

--

  - Data in **tidy** format eases the processing and analysis, particularly in
    vectorized lenguages as R can be.

---

# tidyr

Data is not always organized...


```
## # A tibble: 5,769 x 22
##    iso2   year   m04  m514  m014 m1524 m2534 m3544 m4554 m5564   m65
##    &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1 AD     1989    NA    NA    NA    NA    NA    NA    NA    NA    NA
##  2 AD     1990    NA    NA    NA    NA    NA    NA    NA    NA    NA
##  3 AD     1991    NA    NA    NA    NA    NA    NA    NA    NA    NA
##  4 AD     1992    NA    NA    NA    NA    NA    NA    NA    NA    NA
##  5 AD     1993    NA    NA    NA    NA    NA    NA    NA    NA    NA
##  6 AD     1994    NA    NA    NA    NA    NA    NA    NA    NA    NA
##  7 AD     1996    NA    NA     0     0     0     4     1     0     0
##  8 AD     1997    NA    NA     0     0     1     2     2     1     6
##  9 AD     1998    NA    NA     0     0     0     1     0     0     0
## 10 AD     1999    NA    NA     0     0     0     1     1     0     0
## # … with 5,759 more rows, and 11 more variables: mu &lt;int&gt;, f04 &lt;int&gt;,
## #   f514 &lt;int&gt;, f014 &lt;int&gt;, f1524 &lt;int&gt;, f2534 &lt;int&gt;, f3544 &lt;int&gt;,
## #   f4554 &lt;int&gt;, f5564 &lt;int&gt;, f65 &lt;int&gt;, fu &lt;int&gt;
```

---

# tidyr

.center[

```
## # A tibble: 35,750 x 5
##    iso2   year sex   age_group     n
##    &lt;chr&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;     &lt;int&gt;
##  1 AD     1996 f     014           0
##  2 AD     1996 f     1524          1
##  3 AD     1996 f     2534          1
##  4 AD     1996 f     3544          0
##  5 AD     1996 f     4554          0
##  6 AD     1996 f     5564          1
##  7 AD     1996 f     65            0
##  8 AD     1996 m     014           0
##  9 AD     1996 m     1524          0
## 10 AD     1996 m     2534          0
## # … with 35,740 more rows
```
]

---

# tidyr

## The verbs of tidyr

  - `gather`: Convert data from *wide* to *long* format (columns to id-value pairs)
  - `spread`: Convert data from *long* to *wide* format (id-value pairs to columns)
  - `separate`: Convert one column in serveral
  - `unite`: Join several columns in one

---

# tidyr

## common structure (for most of the tidyverse)

```r
verb(data, ...)
```

- first argument: data (as data.frame or tbl_df)
- the rest of arguments specify what to do with the data frame
- output is always another tbl_df
- unless we are assigning (`&lt;-`), never modifies the original data frame

---

# tidyr

## `gather`


```r
n_parcelas &lt;- tibble(
  Prov = c('Lleida', 'Girona', 'Barcelona', 'Tarragona'),
  IFN_2 = c(16, 78, 60, 34),
  IFN_3 = c(18, 79, 67, 36)
)

n_parcelas
```

```
## # A tibble: 4 x 3
##   Prov      IFN_2 IFN_3
##   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
## 1 Lleida       16    18
## 2 Girona       78    79
## 3 Barcelona    60    67
## 4 Tarragona    34    36
```

---

# tidyr

## `gather`


```r
n_parcelas_tidy &lt;- n_parcelas %&gt;%
  gather(IFN, n, IFN_2, IFN_3)

n_parcelas_tidy
```

```
## # A tibble: 8 x 3
##   Prov      IFN       n
##   &lt;chr&gt;     &lt;chr&gt; &lt;dbl&gt;
## 1 Lleida    IFN_2    16
## 2 Girona    IFN_2    78
## 3 Barcelona IFN_2    60
## 4 Tarragona IFN_2    34
## 5 Lleida    IFN_3    18
## 6 Girona    IFN_3    79
## 7 Barcelona IFN_3    67
## 8 Tarragona IFN_3    36
```

---

# tidyr

## `separate`


```r
n_parcelas_sep &lt;- n_parcelas %&gt;%
  gather(IFN, n, IFN_2, IFN_3) %&gt;%
  separate(IFN, c('name', 'ifn_version'), sep = '_')

n_parcelas_sep
```

```
## # A tibble: 8 x 4
##   Prov      name  ifn_version     n
##   &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;
## 1 Lleida    IFN   2              16
## 2 Girona    IFN   2              78
## 3 Barcelona IFN   2              60
## 4 Tarragona IFN   2              34
## 5 Lleida    IFN   3              18
## 6 Girona    IFN   3              79
## 7 Barcelona IFN   3              67
## 8 Tarragona IFN   3              36
```

---

# `gather` and `separate`

## Exercise 9

Use `gather` and `separate` to transform the data frame species into a **tidy** format,
where each column is a variable and each row an observation

---

# tidyr

## `spread`


```r
n_parcelas_tidy %&gt;%
  spread(IFN, n)
```

```
## # A tibble: 4 x 3
##   Prov      IFN_2 IFN_3
##   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
## 1 Barcelona    60    67
## 2 Girona       78    79
## 3 Lleida       16    18
## 4 Tarragona    34    36
```

---

# tidyr

## `unite`


```r
n_parcelas_sep %&gt;%
  unite(IFN, name, ifn_version, sep = '_')
```

```
## # A tibble: 8 x 3
##   Prov      IFN       n
##   &lt;chr&gt;     &lt;chr&gt; &lt;dbl&gt;
## 1 Lleida    IFN_2    16
## 2 Girona    IFN_2    78
## 3 Barcelona IFN_2    60
## 4 Tarragona IFN_2    34
## 5 Lleida    IFN_3    18
## 6 Girona    IFN_3    79
## 7 Barcelona IFN_3    67
## 8 Tarragona IFN_3    36
```

---

# `spread` and `unite`

## Exercise 10

Use `unite` and `spread` to transform the data from exercise 9 into its original format

---
layout: false
class: inverse
background-image: url(resources/images/purrr.png)

# purrr

---
layout: true

&lt;div class="tweaked-header" style="background-image: url(resources/images/purrr.png)"&gt;&lt;/div&gt;

---

# purrr

Allows to do functional programming with R, making loops and repetitive tasks
pipe-friendly and easier to read.


```r
c(1, 2, 3) %&gt;%
  map_dbl(~ .*2)
```

```
## [1] 2 4 6
```

```r
c('a', 'b', 'c') %&gt;%
  map_chr(~ paste0('treatment_', .))
```

```
## [1] "treatment_a" "treatment_b" "treatment_c"
```

Can be used as alternatives to `apply` family functions (`lapply`, `vapply`...)

---

# purrr

## common structure

```r
verb(.x, .f, ...)
```

- first argument: vector or list (included data frames)
- second argument: function to apply to each element of .x
- output is always a vector or a list of the same length as .x

---

# purrr

## The verbs of purrr

  - `map`: Tranforms the input by applying a function to each element and returning a
    vector the same length as the input
    
  - `walk`: The same as `map`, but only for the side-effect, returning the original input
  
---

# map

## Flavours

  - `map`: Returns always a list
  - `map_chr`, `map_dbl`, `map_int`, `map_lgl`: Returns a vector of the corresponding type
  - `map_dfr`, `map_fdc`: Returns a data frame created by row- or column-binding

---

# map

## functions

Functions to apply to each element can be supplied in different forms:

  - lambda function: starting with `~` and with `.` as the element placeholder


```r
list.files('data', '.csv', full.names = TRUE) %&gt;%
  map_dfr(~ read_csv(., col_types = 'ccccc???????'))
```
  
  - function name: if it needs extra arguments, can be supplied after the function name


```r
list.files('data', '.csv', full.names = TRUE) %&gt;%
  map_dfr(read_csv, col_types = 'ccccc???????')
```

---

# map

## Models workflow become easier


```r
trees %&gt;%
  split(.$Provincia) %&gt;%
  map(~ lm(DiamIf3 ~ HeiIf3, data = .)) %&gt;%
  map_dfr(~ broom::tidy(.))
```

```
##          term estimate   std.error statistic       p.value
## 1 (Intercept) 6.743251 0.116170433  58.04619  0.000000e+00
## 2      HeiIf3 1.401521 0.009756099 143.65588  0.000000e+00
## 3 (Intercept) 8.775570 0.111384238  78.78646  0.000000e+00
## 4      HeiIf3 1.240967 0.009042191 137.24189  0.000000e+00
## 5 (Intercept) 4.559930 0.135614432  33.62422 4.883169e-244
## 6      HeiIf3 1.779256 0.011140341 159.71291  0.000000e+00
## 7 (Intercept) 3.993061 0.208515400  19.14996  2.910426e-80
## 8      HeiIf3 2.056890 0.021341301  96.38074  0.000000e+00
```

---
class: code50

# walk

## Side-effects

Sometimes we want to perform a pipe step only for its side-effect (printing, plotting...)
but continue with the pipe afterwards. We could write an intermediate step or we can use
walk


```r
list.files('data', '.csv', full.names = TRUE) %&gt;%
  walk(print) %&gt;%
  map_dfr(read_csv, col_types = 'ccccc???????')
```

```
## [1] "data/trees_Barcelona.csv"
## [1] "data/trees_Girona.csv"
## [1] "data/trees_Lleida.csv"
## [1] "data/trees_Tarragona.csv"
```

```
## # A tibble: 111,756 x 12
##    Codi  Provincia Cla   Subclase Especie Rumbo  Dist    Fac    CD
##    &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1 0800… 08        A     1        022         7  8.3   31.8     20
##  2 0800… 08        A     1        476        38  9.1   31.8     35
##  3 0800… 08        A     1        021        25  7     31.8     25
##  4 0800… 08        A     1        021        28  8.89  31.8     15
##  5 0800… 08        A     1        021        19 11.2   14.1     35
##  6 0800… 08        A     1        021        32 12     14.1     35
##  7 0800… 08        A     1        243        40  7.8   31.8     15
##  8 0800… 08        A     1        045        16  5.09  31.8     20
##  9 0800… 08        A     1        243        47 26.9    5.09    65
## 10 0800… 08        A     1        022        44  2.7  127.      15
## # … with 111,746 more rows, and 3 more variables: DiamIf3 &lt;dbl&gt;,
## #   DiamIf2 &lt;dbl&gt;, HeiIf3 &lt;dbl&gt;
```

---

# purrr

## Exercise 10

In this exercise we will use some of the knowledge acquired in this workshop

  10.1 Lets see if there is a relationship between leaf biomass (in the `leaf` dataset)
    and tree height (in the `trees` dataset), for each province at the plot level. For that
    you will need to summarise tree values, join with the leaf data, split by provinces and
    perform the model for each province.

---
layout: false
class: thanks clear middle

.font160[Thank you!]

&lt;br&gt;

<i class="fab  fa-twitter "></i> @multivac42  
<i class="fab  fa-github "></i> https://github.com/ameztegui/  

<i class="fab  fa-twitter "></i> @malditobarbudo  
<i class="fab  fa-github "></i> https://github.com/malditobarbudo/  

&lt;br&gt;

Presentation repository:  
<i class="fab  fa-github "></i> https://github.com/ameztegui/tidyverse_workshop
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "tomorrow-night-eighties",
"highlightLanguage": "r",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
